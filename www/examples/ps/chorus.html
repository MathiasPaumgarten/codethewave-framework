<!doctype html> <html class="no-js" lang><head><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><title>Hue</title><meta name="description" content><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><link rel="apple-touch-icon" href="apple-touch-icon.png"><link rel="stylesheet" href="../../main.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/detectizr/2.2.0/detectizr.min.js"></script><script src="../../js/pixi.min.js"></script><script src="../../js/TweenMax.min.js"></script></head><body><!--[if lt IE 8]>

        <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>

    <![endif]--><script src="../../sp-framework.js"></script><script src="/js/ps-includes.js"></script><script>
         
        print = console.log 
        var DEG2RAD = Math.PI / 180.0;

        var currentCast = "";
        var beatInterval = 1500;
        var lastBeatTime;
        var background, sprite, masker;
        var patternColor;
        
        var displacementFilter;
        var displacementSprite;
        var displacementMultiplier = 0.0;

        var videoPatternSprite;

        var sprites = [];
        var spritePositions = [];
        var spriteRotationSpeed = 0;
        var spriteScale = 1.0;

        var touching = false;
        function updatePattern(PIXI, input)
        {
            background.clear();
            background.beginFill(patternColor, 1);
            background.drawRect(0,0,input.width, input.height);
            background.endFill();
        }

        SPF.set({

            at:"back",
            load: function(PIXI, input) 
            {
                return [input.maskers.handdrawnanimal1, input.maskers.botanicorganic1, input.maskers.bbbbird1];
            },

            init: function(PIXI, input) 
            {
                patternColor = input.colors[3];
                background = new PIXI.Graphics();
                input.container.addChild(background);

                var backgroundTexture = PIXI.Texture.fromImage('/assets/ps_temp/SP_pattern_handdrawnanimal.png'); //TODO: Load from framework
                backgroundPattern = SPF.fullscreenSprite(input.container,  backgroundTexture );

	            backgroundColorFilter = new PIXI.filters.ColorMatrixFilter();
                backgroundPattern.filters = [backgroundColorFilter];
                backgroundColorFilter.reset();
                backgroundColorFilter.hue(-120, true);

                var textures = [input.maskers.handdrawnanimal1, input.maskers.botanicorganic1, input.maskers.bbbbird1];
                var tex = textures[Math.round(Math.random() * textures.length - 1)];
                masker = SPF.fullscreenSprite(input.container, tex);
                input.container.addChild(masker);

                backgroundPattern.mask = masker;
                
                //Displacement
                var displacementTexture = PIXI.Texture.fromImage('/assets/ps_temp/clouds.png'); //TODO: Load from framework
                displacementTexture.baseTexture.wrapMode = PIXI.WRAP_MODES.REPEAT
                displacementSprite = new PIXI.Sprite(displacementTexture);//PIXI.Sprite.fromImage('http://i.imgur.com/2yYayZk.png'); 
                displacementFilter = new PIXI.filters.DisplacementFilter(displacementSprite);
                input.container.addChild(displacementSprite);
                backgroundPattern.filters = [displacementFilter];

                var scale = 100;
                displacementFilter.scale.x = scale;
                displacementFilter.scale.y = scale;
                displacementFilter.resolution = 1; //Lower values are faster, higher better quality

                var index = Math.round(Math.random() * 1);
                spriteScale = index == 0 ? 0.45: 1;
                var frontSpriteTexture = PIXI.Texture.fromImage(['/assets/ps_temp/SP_element_crazyflower_001.png', '/assets/SP_element_botanicorganic_001.png'][index]); //TODO: Move to framework, one of these exist
                var spriteCount = 3;
                for(var i = 0;i<spriteCount;i++)
                {
                    var sprite = new PIXI.Sprite(frontSpriteTexture);
                    sprite.anchor.set(0.5);
                    input.container.addChild(sprite);
                    sprites.push(sprite);
                    spritePositions.push(new SPHelpers.Vector2(Math.random(), Math.random()));
                }

                lastBeatTime = new Date().getTime();
            },

            render:function(PIXI, input)
            {
                if(touching)
                {
                    var t = 0.95;
                    displacementMultiplier = (displacementMultiplier * t) + (1 - t);
                }
                else
                {
                    displacementMultiplier *= 0.9;
                }


                var timeSinceBeat = new Date().getTime() - lastBeatTime;
                if (timeSinceBeat > beatInterval)
                {
                    lastBeatTime = new Date().getTime();
                
                    spriteRotationSpeed = 15 * DEG2RAD;
                }

                for(var i = 0;i<sprites.length;i++)
                {
                    sprites[i].rotation += spriteRotationSpeed
                }

                spriteRotationSpeed *= 0.75;
                
                if(input.cast != null && input.cast.id != currentCast)
                {
                    currentCast = input.cast.id
                    //Hues
                    switch(input.cast.id)
                    {
                        case "singer":
                            backgroundColorFilter.reset();
                            patternColor = input.colors[2];
                            videoPatternSprite.tint = 0xfa8474;//0xed8010;
                            break;
                        case "bass":
                        case "drums":
                            backgroundColorFilter.reset();
                            backgroundColorFilter.hue(-170, true);
                            patternColor = input.colors[1];
                            videoPatternSprite.tint = 0xfa8474;
                            break;
                        case "all":
                        case "none":
                        default:
                            backgroundColorFilter.reset();
                            backgroundColorFilter.hue(-120, true);
                            patternColor = input.colors[3];
                            videoPatternSprite.tint = 0x84fc8b;

                            break;
                    }
                    updatePattern(PIXI, input);
                }

                displacementFilter.scale.x =  displacementFilter.scale.y = 200 * displacementMultiplier;
                displacementSprite.x += 1.5 * displacementMultiplier;
                displacementSprite.y += 2.5 * displacementMultiplier;
            },

            mouseDownTouchStart: function(PIXI, input) 
            {
                touching = true;
            },

            mouseUpTouchEnd: function(PIXI, input) 
            {
                touching = false;
            },

            resize: function(PIXI, input) 
            {
                //sprite.width = input.width;
                //sprite.height = input.height;
                updatePattern(PIXI, input);

                /*
                maskSprite.width = input.width;
                maskSprite.height = input.height;

                maskSpriteGraphics.clear();
                maskSpriteGraphics.beginFill(0xff0000);
                maskSpriteGraphics.drawRect(0, 0, input.width, input.height);

                maskSpriteGraphics.mask = maskSprite;
                */
                
                for(var i = 0;i<sprites.length;i++)
                {
                    sprites[i].x = spritePositions[i].x * input.width;
                    sprites[i].y = spritePositions[i].y * input.height;
                    sprites[i].scale.x = sprites[i].scale.y = (input.width / 1000.0) * spriteScale;
                }
            }
        });

        SPF.set({

            at:"mid",

            load: function(PIXI, input) {

                return [input.patterns.botanicorganic2];
            },

            init: function(PIXI, input) {

                var texture = PIXI.Texture.fromImage('/assets/ps_temp/SP_mask_handdrawnanimal_001_TRANSPARENT.png'); //TODO: Load from framework
                //sprite = new PIXI.extras.TilingSprite(input.maskers.handdrawnanimal1, 1, 1);
                videoPatternSprite = new PIXI.extras.TilingSprite(texture, 1, 1);
                videoPatternSprite.anchor.set(0);
                input.container.addChild(videoPatternSprite);
                videoPatternSprite.tint = 0xfa8474;

                SPF.midgroundMask(true);

            },

            resize: function(PIXI, input) {

                var w =  input.width;
                var h =  input.height;

                videoPatternSprite.width = w;
                videoPatternSprite.height = h;


            }

        });

        /*
        SPF.set({

            at:"fore",
            load: function(PIXI, input) 
            {
                return [];
            },

            init: function(PIXI, input) 
            {
                var index = Math.round(Math.random() * 1);
                spriteScale = index == 0 ? 0.45: 1;
                var frontSpriteTexture = PIXI.Texture.fromImage(['/assets/ps_temp/SP_element_crazyflower_001.png', '/assets/SP_element_botanicorganic_001.png'][index]); //TODO: Move to framework, one of these exist
                var spriteCount = 3;
                for(var i = 0;i<spriteCount;i++)
                {
                    var sprite = new PIXI.Sprite(frontSpriteTexture);
                    sprite.anchor.set(0.5);
                    input.container.addChild(sprite);
                    sprites.push(sprite);
                    spritePositions.push(new SPHelpers.Vector2(Math.random(), Math.random()));
                }

                lastBeatTime = new Date().getTime();
            },

            render:function(PIXI, input)
            {
                var timeSinceBeat = new Date().getTime() - lastBeatTime;
                if (timeSinceBeat > beatInterval)
                {
                    lastBeatTime = new Date().getTime();
                    spriteRotationSpeed = 15 * DEG2RAD;
                }

                for(var i = 0;i<sprites.length;i++)
                {
                    sprites[i].rotation += spriteRotationSpeed
                }

                spriteRotationSpeed *= 0.75;
            },

            resize: function(PIXI, input) 
            {
                for(var i = 0;i<sprites.length;i++)
                {
                    sprites[i].x = spritePositions[i].x * input.width;
                    sprites[i].y = spritePositions[i].y * input.height;
                    sprites[i].scale.x = sprites[i].scale.y = (input.width / 1000.0) * spriteScale;
                }
            }
        });
        */
        
        SPF.info({
            debug: false,
            title: "Chorus",
            tip: "",
            firstName: "Patrik",
            lastName: "Svensson",
            email: "ps@molamil.com"
        });

        SPF.start();

    </script></body></html>